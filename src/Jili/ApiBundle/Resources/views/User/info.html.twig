<!doctype html>
<html>
<head>
<meta charset="UTF-8" />
<title>积粒网-个人中心</title>
{% include 'JiliApiBundle::seo.html.twig' %}
<!-- [if lt IE9] -->
<script src="{{ asset('js/html5.js')}}" type="text/javascript"></script>
<!-- [endif] -->
<link href="{{ asset('css/default.css')}}" rel="stylesheet" type="text/css" />
<link href="{{ asset('css/personal.css')}}" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="{{ asset('css/jquery.Jcrop.css')}}" type="text/css" />
<script src="{{ asset('js/jquery-1.7.js')}}" type="text/javascript"></script>
<script src="{{ asset('js/personal.js')}}" type="text/javascript"></script>
<script src="{{ asset('js/jquery.ui.widget.js')}}" type="text/javascript"></script>
<script src="{{ asset('js/jquery.iframe-transport.js')}}" type="text/javascript"></script>
<script src="{{ asset('js/jquery.fileupload.js')}}" type="text/javascript"></script>
<script src="{{ asset('js/jquery.Jcrop.min.js')}}"></script>
<script type="text/javascript">
var path = '{{ asset("") }}';
$(document).ready(function(){ 
    function showPreview(coords){
      var rx = 100 / coords.w;
      var ry = 100 / coords.h;
      $('#preview').css({
        width: Math.round(rx * $('#target').width()) + 'px',
        height: Math.round(ry * $('#target').height()) + 'px',
        marginLeft: '-' + Math.round(rx * coords.x) + 'px',
        marginTop: '-' + Math.round(ry * coords.y) + 'px'
      });
    }
    function checkCoords(){
      if (parseInt($('#w').val())) return true;
      alert('Please select a crop region then press submit.');
      return false;
    }
    function updateCoords(c){
      jQuery('#x').val(c.x);
      jQuery('#y').val(c.y);
      jQuery('#w').val(c.w);
      jQuery('#h').val(c.h);
    }
  $('#attachment').fileupload({
        dataType: 'json',
        done: function (e, data) {
          if(data.result.substr(0,7)!='uploads'){
            $(".errorInfo").html("<font color='red'>"+data.result+"</font>");
          }else{
            //$(".img img").attr("src",path+data.result);
            $(".resDiv").show();
            $(".imageInfo").html("<img src='"+path+data.result+"' id='target'/>");
            $("#resizePath").val(data.result);
            var Jcrop_api;
            $('#target').Jcrop({
              aspectRatio: 1,
              onChange: showPreview,
              onSelect: showPreview,
              onSelect: updateCoords
            },function(){
              this.animateTo([0,0,256,256]);
            });
            $(".resizeimage").html("<img src='"+path+data.result+"' id='preview'/>");
            $(".resizeSubmit").html("<input type='submit' value='上传图片' name='resize' class='resBut'/><br/><input type='submit' value='取消上传' name='cancer' class='cancerBut'/>");
          }  
        }
    });
  {% if codeflag %}
      $("#info").hide();
      $("#updateInfo").show();
      var year = $("#yearInfo");  
      var month = $("#monthInfo");  
      var newYear = {{ newYear }};
      var newMonth = {{ newMonth }};
      var yearhtml = '';
      var monthhtml = '';
      var date = new Date();  
      var y = date.getFullYear();  
      yearhtml += "<option value='0'>请选择年</option>";   
      for (var i = 1940; i <= y ; i++) {  
         if({{ year }}){
            var usernewYear = {{ year }};
            var selected = (usernewYear == i)?"selected='selected'":""; 
         }else{
            var selected = (newYear == i)?"selected='selected'":""; 
         }
         yearhtml += "<option value='"+i+ "' " + selected+ " >"+i+"</option>";
      } 
      year.html(yearhtml);
      monthhtml += "<option value='0'>请选择月</option>";   
      for (var i = 1; i < 13; i++) {  
          var selected = '';
          if({{ month }}){
            var usernewMonth = {{ month }};
            var selected = (usernewMonth == i)?"selected='selected'":""; 
          }
          if(newMonth) 
              selected = (newMonth == i)?"selected='selected'":""; 
          monthhtml += "<option value='"+i+ "' " + selected+ " >"+i+"</option>"; 
      }
      month.html(monthhtml);
      var html = '';
      {% if provinceId %}
      $.ajax({
            url: "{{ path('_user_getCity') }}?cid={{ provinceId }}",
            post: "GET",
            success:function(data){
              var obj = eval(data);
              for(var i=0;i<obj.length;i++){ 
                  var selected = '';
                 if({{ city }}){
                    var oldcity = {{ city }};
                    selected = ( oldcity == obj[i]['id'])?"selected='selected'":""; 
                 }
                 html += "<option value='"+obj[i]['id']+"'  " + selected+ " >"+obj[i]['cityName']+"</option>";                 
              }
              $("#cityInfo").html(html); 
            }
        });
    {% endif %}
  {% else %}
      $("#updateInfo").hide();
  {% endif %}
  $(".upload").click(function (){
      $("#form1").submit();
  });
  $("#change").click(function (){
      {% if existUserinfo %}
          $("#info").hide();
          $("#updateInfo").show();
          // var oldcity = {{ user.city }};
          var html = '';
          {% if user.province %}
            $.ajax({
                  url: "{{ path('_user_getCity') }}?cid={{ user.province }}",
                  post: "GET",
                  success:function(data){
                    var obj = eval(data);
                    for(var i=0;i<obj.length;i++){ 
                        var selected = '';
                       if({{ user.city }}){
                          var oldcity = {{ user.city }};
                          selected = ( oldcity == obj[i]['id'])?"selected='selected'":""; 
                       }

                       html += "<option value='"+obj[i]['id']+"'  " + selected+ " >"+obj[i]['cityName']+"</option>";                 
                    }
                    $("#cityInfo").html(html); 
                  }
              });
          {% endif %}
          var year = $("#yearInfo");  
          var month = $("#monthInfo");  
          var newYear = {{ newYear }};
          var newMonth = {{ newMonth }};
          var yearhtml = '';
          var monthhtml = '';
          var date = new Date();  
          var y = date.getFullYear();  
          yearhtml += "<option value='0'>请选择年</option>";   
          for (var i = 1940; i <= y ; i++) {  
             var selected = (newYear == i)?"selected='selected'":""; 
             yearhtml += "<option value='"+i+ "' " + selected+ " >"+i+"</option>";
          } 
          year.html(yearhtml);
          monthhtml += "<option value='0'>请选择月</option>";   
          for (var i = 1; i < 13; i++) {  
              var selected = '';
                if(newMonth) 
                  selected = (newMonth == i)?"selected='selected'":""; 
                monthhtml += "<option value='"+i+ "' " + selected+ " >"+i+"</option>"; 
          }
          month.html(monthhtml);
       
         
      {% else %}
           window.location.href = "{{ path('_user_registerReward') }}";
      {% endif %}
  })
   
});
function selectYear(){
  var month = $("#monthInfo"); 
  if($("#yearInfo").val()=='0'){
    month.get(0).options.length = 0; 
    month.get(0).options.add(new Option("请选择月", "0"));  
  }else{
    month.get(0).options.length = 0; 
    month.get(0).options.add(new Option("请选择月", "0"));  
    for (var i = 1; i < 13; i++) {  
            month.get(0).options.add(new Option(i, i));  
    }
  }
}
function selectCity(){
  var html = ''; 
  if($("#provinceInfo").val()!=0){
     $.ajax({
              url: "{{ path('_user_getCity') }}?cid="+$('#provinceInfo').val(),
              post: "GET",
              success:function(data){
                var obj = eval(data);
                for(var i=0;i<obj.length;i++){ 
                    html += "<option value='"+obj[i]['id']+"'>"+obj[i]['cityName']+"</option>";                 
                }
                $("#cityInfo").html(html); 
              }
          });
  }else{
      html += "<option value='0'>请选择地区</option>";   
      $("#cityInfo").html(html);
  }
}
</script>
</head>

<body>
{% include 'JiliApiBundle::header.html.twig' %}
<div class="personal">
  <section class="line">
    <div class="photo">
      <div class="img">
          {% if user.iconPath %}
              <img src='{{ asset(user.iconPath) }}' height='110'/>
          {% else %}
              <img src='{{ asset("images/default_face.jpg") }}' height='110'/>
          {% endif %}
        </div>
        <form action="{{ path('_user_info') }}" method="post" {{ form_enctype(form) }} id="form1">
        <p><span>{{ user.nick }}</span>,欢迎您</p><p><img class="mili" src='{{ asset("images/mili.jpg") }}' />我的米粒数：<span>{{ user.points }}</span>
        {% if countMessage %}
          <a href="{{ path('_user_message',{'sid': 2}) }}" class="message" style="margin-left:50px">
        {% else %}
          <a href="{{ path('_user_message',{'sid': 1}) }}" class="message" style="margin-left:50px">
        {% endif %}
        站内消息</a><a href="{{ asset(path('_user_changePwd'),'cdn1') }}" class="passwordEdit">修改密码</a></p><p>{{ form_widget(form.attachment) }}</p>
        <p class="errorInfo"></p></form>
        <div class="clear"></div>
        <form action="{{ path('_user_resUp') }}" method="post">
        <div style="float:left; margin-left:150px;"><p class="imageInfo"></p></div>
        <div class="resDiv">
         <div class="resImg"><p class="resizeimage" style="margin:0;"></p></div>
          <input type="hidden" id="x" name="x" />
          <input type="hidden" id="y" name="y" />
          <input type="hidden" id="w" name="w" />
          <input type="hidden" id="h" name="h" />
          <input type="hidden" id="resizePath"  name="resizePath" />
          <div class="resizeSubmit">
          </div>
         </div>
        </form>
        <div class="clear">
         </div>
    </div>
  </section>
  
<section id= "info">
    <h3>个人信息<a class="close">关闭</a><a class="open" style="display:none;">打开</a></h3>
    <div class="content info">
      <a class="edit" href="javascript:void(0);" id="change">修改 »</a>
      <ul>
        <li>
          <dd>登录账号：</dd>
          <dt>{{ user.email }} </dt>
        </li>
        <li style="width:40%;">
          <dd>昵  称：</dd>
          <dt>{{ user.nick }}</dt>
        </li>
        <li style="width:60%;">
          <dd>性  别：</dd>
          <dt>{% if user.sex==1 %} 
         男{% elseif user.sex==2 %}女{% else %}&nbsp;{% endif %}</dt>
        </li>

         <li  style="width:40%;">
          <dd>出  生：</dd>
          <dt>{% if newYear %} 
                {% if newMonth %}
                    {{ newYear }}年{{ newMonth }}月
                {% else %}
                    {{ newYear }}年
                {% endif %}
              {% else %}
                  &nbsp;
              {% endif %}</dt>
        </li>
      
        <li style="width:60%;">
          <dd>地  区：</dd>
          <dt>
            {{ disarea }}
          </dt>
        </li>  

        <li>
          <dd>手机号码：</dd>
          <dt>
            {{ user.tel }}
          </dt>
        </li>  

        <li>
          <dd>个人月收入:</dd>
          <dt>
            {{ usercomes }}
          </dt>
        </li>  

        <li>
          <dd>兴趣爱好：</dd>
          <dt>
            {{ userHobby }}
          </dt>
        </li>  

      </ul>
    </div>
  </section>
  
  <section id= "updateInfo">
   <form action="{{ path('_user_info') }}" method="post">
    <h3>个人信息<a class="close">关闭</a><a class="open" style="display:none;">打开</a></h3>
    <div class="content info">
      <a class="edit" href="javascript:void(0);" id="change">修改 »</a>
      <ul>
        <li>
          <dd>登录账号：</dd>
          <dt>{{ user.email }}  </dt>
        </li>
        <li style="width:40%;">
          <dd>昵  称：</dd>
          <dt>
             {{ user.nick }}
          </dt>
        </li>
        <li style="width:60%;">
          <dd><font style="color:#EE472C;"> * </font>性  别：</dd>
          <dt>
            <input name="sex" type="radio" {% if sex %}{% if sex==1 %} checked='checked' {% endif %}{% endif %}{% if user.sex==1 %} checked='checked' {% endif %} value="1">
            男
            <input name="sex" type="radio" {% if sex %}{% if sex==2 %} checked='checked' {% endif %}{% endif %}{% if user.sex==2 %} checked='checked' {% endif %} value="2">
            女</dt>
        </li>


       <li style="width:40%;"><dd><font style="color:#EE472C;"> * </font>出生年月：</dd>
            <dt><select id="yearInfo" name="year" onchange="selectYear()"></select>      
            &nbsp;<select id="monthInfo" name="month"></select>      
          </dt>
      </li>

          <li style="width:60%;"><dd><font style="color:#EE472C;"> * </font>地区：</dd>
            <dt><select id="provinceInfo" name="province" onchange="selectCity()">
            <option value="0">请选择省</option>
              {% for item in province %}
               <option value="{{ item.id }}" {% if provinceId %} {% if provinceId == item.id %} selected = "selected" {% endif %} {% endif %}{% if user.province == item.id %} selected = "selected" {% endif %}>{{ item.provinceName }}</option>
              {% endfor %}
            
            </select>
            <select id="cityInfo" name="city"><option value='0'>请选择地区</option>
              </select>
              </dt></li>


        <li>
          <dd>手机号码：</dd>
          <dt>
        <input name="tel" type="text" value="{% if tel %}{{ tel }}{% else %}{{ user.tel }}{% endif %}">
          </dt>
        </li>

         <li>
          <dd><font style="color:#EE472C;"> * </font>个人月收入：</dd>
          <dt>
           {% for item in income %}
            <input name="income" type="radio" value="{{ item.id }}" {% if month_income %}{% if month_income==item.id %} checked='checked' {% endif %}{% endif %}{% if user.income == item.id %} checked = "checked" {% endif %}>{{ item.income }}
            {% endfor %}
          </dt>
        </li>

         <li>
          <dd><font style="color:#EE472C;"> * </font>兴趣爱好：</dd>
          <dt>
           {% for item in hobbyList %}
            <input type="checkbox"  name="hobby[]" value="{{ item.id }}" {% if hobby %}{% for i in hobby %} {% if i ==item.id %} checked = "checked" {% endif %}{% endfor %}{% endif %}  {% if newHobby %}{% for i in newHobby %} {% if i ==item.id %} checked = "checked" {% endif %}{% endfor %}{% endif %}>{{ item.hobbyName }}
           {% endfor %}
                  <br/>
                   {% if codeflag  %}
                     <font color='red'>{{ codeflag }}</font>
                   {% endif %}
          </dt>
        </li>

        <li><dd>&nbsp;</dd>
          <dt>
            <input name="update" type="submit" value="保存" class="infoFinish">
            <input name="reset" type="submit" value="取消" class="infoReset">
          </dt>
        </li>
      </ul>
    </div>
</form>
  </section>

  <section>

    <h3>我的任务历史<a class="close">关闭</a><a class="open" style="display:none;">打开</a></h3>
    <div class="content ad">
    {% if adtasteNum > 0 %}
      <p class="prompt">*&nbsp;商家审核需要8周，判定有效后立即到账（退货无返利）</p>
      <a href="{{ asset(path('_user_adtaste',{'type': 1}),'cdn1') }}" class="more edit">更多 »</a>
    {% endif %}
      <table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
          <th>任务类型</th>
          <th>任务名称</th>
          <th>奖励积分</th>
          <th>任务领取时间</th>
          <th>任务状态</th>
        </tr>     
         {% for item in adtaste %}
        <tr>
          <td>
        {{ item.displayName }}
          </td>
          <td>
            {% if item.adid %}<a href="{{ asset(path('_advertiserment_index',{'id':item.adid}),'cdn1') }}" target="_blank">{{ item.title }}</a>
              {% else%}
              <a href="{{ asset(path('_game_index'),'cdn1') }}" target="_blank">{{ item.title }}</a>
              {% endif %}  
          </td>
          <td>{% if item.incentiveType==2 %}
                     {% if item.orderStatus > 1 %}
                        {{ item.incentive }}米粒
                     {% else %}
                     {% endif %}
              {% else %}
                     {{ item.incentive }}米粒
              {% endif %}</td>
          <td>{{ item.createTime.date }}</td>
          <td>{% if item.incentiveType==1 or item.incentiveType==2 %}
                  {% if item.orderStatus==1  %} 已参加
                  {% elseif item.orderStatus==2  %} 确认中
                  {% elseif item.orderStatus==3  %} 已完成
                  {% elseif item.orderStatus==4  %} 任务失败
                  {% else %}{% endif %}
              {% else %}
                  {% if item.orderStatus==0  %} 确认中
                  {% elseif item.orderStatus==1  %} 已完成
                  {% else %} 任务失败
                  {% endif %}
              {% endif %}
          </td>
        </tr>
         {% endfor %}
        {% if adtasteNum == 0 %}
        <tr><td align="center" colspan="5">没有任务记录</td></tr>
        {% endif %}
      </table>
     
    </div>
  </section>
  <section>
    <h3>我的兑换历史<a class="close">关闭</a><a class="open" style="display:none;">打开</a></h3>
    <div class="content score">
      <table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
          <th>兑换申请时间</th>
          <th>兑换方式</th>
          <th>米粒数</th>
          <th>兑换完成时间</th>
          <th>状态</th>
        </tr>
        {% if exchange %}
        {% for item in exchange %}
        <tr>
          <td>{{ item.exchangeDate.date | date('Y-m-d') }}</td>
          <td>{{ item.type }}</td>
           <td>{{ item.targetPoint }}</td>
          <td>{% if item.status %} {{ item.finishDate.date | date('Y-m-d')  }} {% else %} {% endif %}</td>
          <td>{% if item.status %}{% if item.status==1 %}兑换成功 {% elseif item.status==2 %}兑换失败 {% else %} {% endif %} {% else %} 处理中 {% endif %}</td>
        </tr>
        {% endfor %}
          <a href="{{  asset(path('_user_exchange',{'type': 1}),'cdn1') }}" class="more edit">更多 »</a>
        {% else %}
        <tr><td align="center" colspan="5">没有兑换记录</td></tr>
        {% endif %}
      </table>
    
    </div>
  </section>
  <!--  <section>
    <h3>账户扩展<a class="close">关闭</a><a class="open" style="display:none;">打开</a></h3>
    <div class="content expand">
      内容
    </div>
  </section>-->
</div>
{% include 'JiliApiBundle::footer.html.twig' %}
</body>
</html>