<script type="text/javascript">
    var ghs_list = {
        last_page: {{ last_page }},
        current_page: {{ page }}
    };

var next = function() {
	var last_page;
	var fetched;
	return {
		init: function(params) {
			last_page = params.last_page;
			fetched = [params.current_page];
		},
		getLastPage: function() {
			return last_page;
		},
		getFetched: function() {
			return fetched;
		},
		getNext: function() {
			var pool = [];
			if (fetched.length > 0 && fetched.length < last_page) {

				for (var i = 1; i <= last_page; i++) {
					if ( - 1 === fetched.indexOf(i)) {
						pool.push(i);
					}
				}
			} else {
				fetched = [];
				for (var i = 1; i <= last_page; i++) {
					pool.push(i);
				}
			}
			var ind = Math.floor(Math.random() * (pool.length - 1));
			var next = pool[ind];
			fetched.push(next);
			return next;
		},
	}
} ();

$(document).ready(function(){
    $(".loading").hide();

    next.init(ghs_list);
    //刷新
    $(".more").click(function(){
        $.ajax({
            url: "{{ path('jili_emar_ghs_promotion') }}/top/6/"+next.getNext(),
            post: "POST",
            beforeSend:function(){$(".loading").show();},
            success:function(data){

			if(data.prds != null && data.prds.length > 0) {
                    var msg = "";
                    for(var i = 0; i < data.prds.length; i++) {
                       var  data2 = data.prds[i];
                        if (0 == (i+1) % 3 ){
                            msg += '<li class="mr0">';
                        }else{  
							msg += "<li>";
                        }
						if ( data2.href == "{{ path('_user_login')  }}" ){
                        msg += '<p class="image"><a href="'+data2.href+'" ><img src="'+data2.pic+'" height="130" width="200"></a></p><p class="name">'+data2.name+'</p><p class="price"><span class="price1">¥</span><span class="price2">'+data2.pri1+'</span><del class="corLightGray">￥'+data2.pri0+'</del>';
                        if( data2.dis > 0 ) {
                          msg += '<span class="discount corLightGray">返利最高<br/><span class="corGlobRed">'+data2.dis+'%</span></span>';
                        }
                        msg += '</p>'+'<p class="corLightGray">销量'+data2.buy+'件</p>';
						msg += '<div class="model hoverView curPt">';
					    msg += '<a href="'+ data2.href+'" ><span><img src="{{ asset('images140307/iconGlass.png') }}" width="23" height="23"></span><strong class="corWhite">去看看</strong></a>';
 				
						} else {
                            msg += '<p class="image"><a href="'+data2.href+'" target="_blank" rel="nofollow"><img src="'+data2.pic+'" height="130" width="200"></a></p><p class="name">'+data2.name+'</p><p class="price"><span class="price1">¥</span><span class="price2">'+data2.pri1+'</span><del class="corLightGray">￥'+data2.pri0+'</del>';
                        if( data2.dis > 0 ) {
                          msg += '<span class="discount corLightGray">返利最高<br/><span class="corGlobRed">'+data2.dis+'%</span></span>';
                        }

                            msg +='</p><p class="corLightGray">销量'+data2.buy+'件</p>';
							  msg += '<div class="model hoverView curPt">';
							  msg += '<a href="'+ data2.href+'" target="_blank" rel="nofollow"><span><img src="{{ asset('images140307/iconGlass.png') }}" width="23" height="23"></span><strong class="corWhite">去看看</strong></a>'; 
 						}					
						 msg += '</div></li>';
           			  }
					  
                    $("#prds1").html(msg);
					slideUp();
    			 }
                $(".loading").hide();
                return false;
            }
        });
    });
});
</script>
<script type="text/javascript">
  $(document).ready(function() {
	slideUp();
  })
  
  function slideUp(){
  	$("#indexRecommend ul li").hover(function() {
		$(this).children(".model").css("display","block");
		$(this).children(".model").animate({bottom:0},200);
	},function() {
		$(this).children(".model").animate({bottom:-90},200);
 	});
  }
</script>
{% spaceless %}
      <h3>超值低价</h3>
      <div class="menu"><a class="more" href="javascript:void(0);">换一批</a></div>
      <div class="loading"><img src="{{ asset('other/loading.gif') }}" width="32" height="32"></div>
      <ul class="clearfix">
        <span id="prds1">
         {% for row in ghs_pdts %}
            <li{{ 0 == loop.index % 3? ' class="mr0" ':'' }}>
                 <p class="image">
                  <a href="{{ path('jili_emar_default_redirect') ~ '?m=' ~ row.ghs_o_url|url_encode }}" target="_blank" rel="nofollow">
                 <img src="{{ row.pic_url }}" height="auto" width="200"></a></p>
			 <p class="name">{{ row.p_name }}</p>
             <p class="price"><span class="price1">¥</span><span class="price2">{{ row.ghs_price }}</span><del class="corLightGray">原价￥{{ row.ori_price }}</del>

        {% if  row.discount > 0 %}
           <span class="discount corLightGray">返利最高<br/><span class="corGlobRed">{{ row.discount * emar_cps_default_rebate / 100 |round(2)  }}%</span></span>
        {% endif %}
             </p> 
                 <p class="corLightGray">销量{{ row.bought }}件</p>
				 <div class="model hoverView curPt">
				  <a href="{{ path('jili_emar_default_redirect') ~ '?m=' ~ row.ghs_o_url|url_encode }}" target="_blank" rel="nofollow"><span><img src="{{ asset('images140307/iconGlass.png') }}" width="23" height="23"></span><strong class="corWhite">去看看</strong></a>
				 </div>
             </li>
         {% endfor %}
         </span>
    </ul>
{% endspaceless %}

